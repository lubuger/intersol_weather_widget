<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Weather widget</title>

    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css">
    <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>

    <link rel="stylesheet" href="https://cdn.rawgit.com/CreativeIT/getmdl-select/master/getmdl-select.min.css">
    <script defer src="https://cdn.rawgit.com/CreativeIT/getmdl-select/master/getmdl-select.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>

    <link rel="stylesheet" href="http://localhost/intersol/style.css">
    <script type="text/javascript" src="http://localhost/intersol/core.js"></script>

</head>
<body>


<div class="mdl-grid">

    <div class="mdl-cell mdl-cell--12-col">

        <h4>Действующие виджеты</h4>

        <table id="widget-table" class="mdl-data-table mdl-js-data-table mdl-shadow--2dp">
            <thead>
            <tr>
                <th class="mdl-data-table__cell--non-numeric">Хост</th>
                <th class="mdl-data-table__cell--non-numeric">Пользователь</th>
                <th class="mdl-data-table__cell--non-numeric">Город</th>
                <th class="mdl-data-table__cell--non-numeric">Вид блока</th>
                <th class="mdl-data-table__cell--non-numeric">Адрес виджета</th>
                <th class="mdl-data-table__cell--non-numeric">Редактировать</th>
                <th>Кол-во дней</th>
            </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

</div>

<div class="mdl-grid">
    <div class="mdl-cell mdl-cell--12-col">

        <label class="city-chooser mdl-radio mdl-js-radio mdl-js-ripple-effect" for="option-1">
            <input type="radio" id="option-1" class="mdl-radio__button" name="city" value="Москва" checked>
            <span class="mdl-radio__label">Москва</span>
        </label>
        <label class="city-chooser mdl-radio mdl-js-radio mdl-js-ripple-effect" for="option-2">
            <input type="radio" id="option-2" class="mdl-radio__button" name="city" value="Санкт-петербург">
            <span class="mdl-radio__label">Санкт-петербург</span>
        </label>
        <label class="city-chooser mdl-radio mdl-js-radio mdl-js-ripple-effect" for="option-3">
            <input type="radio" id="option-3" class="mdl-radio__button" name="city" value="Нижний Новгород">
            <span class="mdl-radio__label">Нижний Новгород</span>
        </label>

    </div>
</div>

<div class="mdl-grid">
    <div class="mdl-cell mdl-cell--12-col">

        <label class="days-chooser mdl-radio mdl-js-radio mdl-js-ripple-effect" for="option-6">
            <input type="radio" id="option-6" class="mdl-radio__button" name="days" value="1" checked>
            <span class="mdl-radio__label">1 день</span>
        </label>
        <label class="days-chooser mdl-radio mdl-js-radio mdl-js-ripple-effect" for="option-7">
            <input type="radio" id="option-7" class="mdl-radio__button" name="days" value="3">
            <span class="mdl-radio__label">3 дня</span>
        </label>
        <label class="days-chooser mdl-radio mdl-js-radio mdl-js-ripple-effect" for="option-8">
            <input type="radio" id="option-8" class="mdl-radio__button" name="days" value="7">
            <span class="mdl-radio__label">Неделя</span>
        </label>

    </div>
</div>

<div class="mdl-grid">
    <div class="mdl-cell mdl-cell--12-col">

        <label class="pos-chooser mdl-radio mdl-js-radio mdl-js-ripple-effect" for="option-4">
            <input type="radio" id="option-4" class="mdl-radio__button" name="position" value="Vertical" checked>
            <span class="mdl-radio__label">Вертикально</span>
        </label>
        <label class="pos-chooser mdl-radio mdl-js-radio mdl-js-ripple-effect" for="option-5">
            <input type="radio" id="option-5" class="mdl-radio__button" name="position" value="Horizontal">
            <span class="mdl-radio__label">Горизонтально</span>
        </label>

    </div>
</div>

<div class="mdl-grid">
    <div class="mdl-cell mdl-cell--12-col">
        <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label getmdl-select" id="users-list">
            <input class="mdl-textfield__input" id="users" name="user" type="text" readonly tabIndex="-1"/>
            <label class="mdl-textfield__label" for="users">Users</label>
            <ul class="mdl-menu mdl-menu--bottom-left mdl-js-menu" for="users"></ul>
        </div>
    </div>
</div>


<div class="mdl-grid">
    <div class="mdl-cell mdl-cell--12-col">

        <button id="create" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect">
            Создать виджет
        </button>

    </div>
</div>

<dialog class="mdl-dialog">
    <h4 class="mdl-dialog__title">Обновить</h4>
    <div class="mdl-dialog__content">

        <div class="mdl-grid">
            <div class="mdl-cell mdl-cell--12-col">

                <label class="city-chooser-modal mdl-radio mdl-js-radio mdl-js-ripple-effect" for="option-10">
                    <input type="radio" id="option-10" class="mdl-radio__button" name="city" value="Москва" checked>
                    <span class="mdl-radio__label">Москва</span>
                </label>
                <label class="city-chooser-modal mdl-radio mdl-js-radio mdl-js-ripple-effect" for="option-11">
                    <input type="radio" id="option-11" class="mdl-radio__button" name="city" value="Санкт-петербург">
                    <span class="mdl-radio__label">Санкт-петербург</span>
                </label>
                <label class="city-chooser-modal mdl-radio mdl-js-radio mdl-js-ripple-effect" for="option-12">
                    <input type="radio" id="option-12" class="mdl-radio__button" name="city" value="Нижний Новгород">
                    <span class="mdl-radio__label">Нижний Новгород</span>
                </label>

            </div>
        </div>

        <div class="mdl-grid">
            <div class="mdl-cell mdl-cell--12-col">

                <label class="days-chooser-modal mdl-radio mdl-js-radio mdl-js-ripple-effect" for="option-13">
                    <input type="radio" id="option-13" class="mdl-radio__button" name="days" value="1">
                    <span class="mdl-radio__label">1 день</span>
                </label>
                <label class="days-chooser-modal mdl-radio mdl-js-radio mdl-js-ripple-effect" for="option-14">
                    <input type="radio" id="option-14" class="mdl-radio__button" name="days" value="3">
                    <span class="mdl-radio__label">3 дня</span>
                </label>
                <label class="days-chooser-modal mdl-radio mdl-js-radio mdl-js-ripple-effect" for="option-15">
                    <input type="radio" id="option-15" class="mdl-radio__button" name="days" value="7">
                    <span class="mdl-radio__label">Неделя</span>
                </label>

            </div>
        </div>

        <div class="mdl-grid">
            <div class="mdl-cell mdl-cell--12-col">

                <label class="pos-chooser-modal mdl-radio mdl-js-radio mdl-js-ripple-effect" for="option-16">
                    <input type="radio" id="option-16" class="mdl-radio__button" name="position" value="Vertical" checked>
                    <span class="mdl-radio__label">Вертикально</span>
                </label>
                <label class="pos-chooser-modal mdl-radio mdl-js-radio mdl-js-ripple-effect" for="option-17">
                    <input type="radio" id="option-17" class="mdl-radio__button" name="position" value="Horizontal">
                    <span class="mdl-radio__label">Горизонтально</span>
                </label>

            </div>
        </div>

        <div class="mdl-grid">
            <div class="mdl-cell mdl-cell--12-col">
                <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label getmdl-select" id="users-list-modal">
                    <input class="mdl-textfield__input" id="users-modal" name="user" type="text" readonly tabIndex="-1"/>
                    <label class="mdl-textfield__label" for="users-modal">Users</label>
                    <ul class="mdl-menu mdl-menu--bottom-left mdl-js-menu" for="users-modal"></ul>
                </div>
            </div>
        </div>

    </div>
    <div class="mdl-dialog__actions">
        <button id="update" type="button" class="mdl-button">Сохранить</button>
        <button type="button" class="mdl-button close">Отмена</button>
    </div>
</dialog>


<script type="text/javascript">

    var updateId = null;

    $(document).ready( function() {

        Widget.listUsers(function( data ) {

            var ul = $('#users-list').find('ul');
            var ulModal = $('#users-list-modal').find('ul');
            var list = '';

            ul.html('');
            ulModal.html('');

            for(var i=0; i<data.length; i++)
            {
                list += '<li class="mdl-menu__item" data-val="' + data[i].username + '">' + data[i].username + '</li>'
            }

            ul.html( list );
            ulModal.html( list );

            $('#users-list .mdl-menu__item').click(function() {
                var username = $(this).text();
                $('#users').val( username );

                //Stupid framework, you should never used it !!!
                $(this).parent().parent().parent().addClass('is-visible');
                $(this).parent().parent().parent().addClass('is-focused');
            });

            $('#users-list-modal .mdl-menu__item').click(function() {
                var username = $(this).text();
                $('#users-modal').val( username );

                //Stupid framework, you should never used it !!!
                $(this).parent().parent().parent().addClass('is-visible');
                $(this).parent().parent().parent().addClass('is-focused');
            });

        });

        Widget.list( function( data ) {

            var table = $('#widget-table');
            var tbody = table.find('tbody');
            var html = '';

            tbody.html('');

            for(var i=0; i<data.length; i++)
            {
                var host = ( typeof data[i].host !== "undefined") ? data[i].host : '-';

                html += '<tr>';
                html += '<td class="mdl-data-table__cell--non-numeric">' + host + '</td>';
                html += '<td class="mdl-data-table__cell--non-numeric">' + data[i].user + '</td>';
                html += '<td class="mdl-data-table__cell--non-numeric">' + data[i].city + '</td>';
                html += '<td class="mdl-data-table__cell--non-numeric">' + data[i].pos + '</td>';
                html += '<td>' + Widget.url + '/get?id=' + data[i].name.slice(6) + '</td>';
                html += '<td>' + data[i].days + '</td>';
                html += '<td class="show-dialog"><i class="material-icons">edit</i></td>';
                html += '</tr>';
            }

            tbody.html( html );

            var dialog = document.querySelector('dialog');
            var showDialogButton = $('.show-dialog');
            if (! dialog.showModal) {
                dialogPolyfill.registerDialog(dialog);
            }

            showDialogButton.click(function() {

                var row = $(this).parent();
                var days = row.find('td:nth-child(6)').text();
                var city = row.find('td:nth-child(3)').text();
                var pos  = row.find('td:nth-child(4)').text();

                $('.days-chooser-modal').find('[value="' + days + '"]').trigger('click');
                $('.city-chooser-modal').find('[value="' + city + '"]').trigger('click');
                $('.pos-chooser-modal').find('[value="' + pos + '"]').trigger('click');

                updateId = row.find('td:nth-child(5)').text().split('id')[1].slice(1);

                dialog.showModal();
            });

            dialog.querySelector('.close').addEventListener('click', function() {
                dialog.close();
            });

        } );

    });

    $('#create').click(function () {

        var city = 1, days = 1, position = 1, username = 'admin';

        $('.city-chooser').each(function() {

            if( $(this).hasClass('is-checked') )
                city = $(this).find('.mdl-radio__button').val();

        });

        $('.days-chooser').each(function() {

            if( $(this).hasClass('is-checked') )
                days = $(this).find('.mdl-radio__button').val();

        });

        $('.pos-chooser').each(function() {

            if( $(this).hasClass('is-checked') )
                position = $(this).find('.mdl-radio__button').val();

        });

        username = $('#users').val();

        Widget.create( city, days, position, username );
    });

    $('#update').click(function () {

        var city = 1, days = 1, position = 1, username = 'admin';

        $('.city-chooser-modal').each(function() {

            if( $(this).hasClass('is-checked') )
                city = $(this).find('.mdl-radio__button').val();

        });

        $('.days-chooser-modal').each(function() {

            if( $(this).hasClass('is-checked') )
                days = $(this).find('.mdl-radio__button').val();

        });

        $('.pos-chooser-modal').each(function() {

            if( $(this).hasClass('is-checked') )
                position = $(this).find('.mdl-radio__button').val();

        });

        username = $('#users-modal').val();

        if( updateId !== null)
            Widget.update( city, days, position, username, updateId );

        updateId = null;
    });

</script>
</body>
</html>